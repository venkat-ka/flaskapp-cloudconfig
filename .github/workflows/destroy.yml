name: Terraform Destroy AWS Resources

on:
  workflow_dispatch:   # Run manually from GitHub Actions tab
  # delete:             # Uncomment to auto-destroy on branch delete

permissions:
  id-token: write
  contents: read

jobs:
  terraform-destroy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout your Terraform code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Configure AWS OIDC credentials
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 3ï¸âƒ£ Setup Terraform CLI
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.8

      # 4ï¸âƒ£ Initialize Terraform backend (S3 state)
      - name: Terraform Init
        run: terraform init -reconfigure

      # 5ï¸âƒ£ Destroy all Terraform-managed resources
      - name: Terraform Destroy
        env:
          TF_VAR_ssh_public_key_b64: ${{ secrets.SSH_PUBLIC_KEY_B64 }}
        run: terraform destroy -auto-approve -input=false

      # 6ï¸âƒ£ Verify Cleanup â€” Ensure EC2 and EIP are gone
      - name: Verify AWS Cleanup âœ…
        run: |
          echo "ğŸ” Checking for leftover EC2 instances or Elastic IPs..."
          aws ec2 describe-instances --filters "Name=tag:Name,Values=flask-instance" --region ${{ secrets.AWS_REGION }} --query "Reservations[].Instances[].InstanceId" --output text > instances.txt || true
          aws ec2 describe-addresses --region ${{ secrets.AWS_REGION }} --query "Addresses[].PublicIp" --output text > eips.txt || true

          echo "ğŸ§¾ Remaining EC2 Instances:"
          cat instances.txt
          echo "ğŸ§¾ Remaining Elastic IPs:"
          cat eips.txt

          if [ -s instances.txt ] || [ -s eips.txt ]; then
            echo "âŒ Warning: Some resources still exist in AWS!"
            echo "ğŸ‘‰ Check AWS Console to ensure cleanup."
            exit 1
          else
            echo "âœ… Verified: All Terraform resources are fully destroyed."
          fi
